![logo](https://eliasdh.com/assets/media/images/logo-github.png)
# ðŸ’™ðŸ¤Create K8s ClusterðŸ¤ðŸ’™

## ðŸ“˜Table of Contents

1. [ðŸ“˜Table of Contents](#ðŸ“˜table-of-contents)
2. [ðŸ––Introduction](#ðŸ––introduction)
3. [âœ¨Steps](#âœ¨steps)
    1. [ðŸ‘‰Step 1: Set up basic configuration](#ðŸ‘‰step-1-set-up-basic-configuration)
    2. [ðŸ‘‰Step 2: Install and Configure Kubernetes](#ðŸ‘‰step-2-install-and-configure-kubernetes)
    3. [ðŸ‘‰Step 3: Initialize the Kubernetes cluster](#ðŸ‘‰step-3-initialize-the-kubernetes-cluster)
4. [ðŸ”—Links](#ðŸ”—links)

---

## ðŸ––Introduction

This document describes the steps to create a Kubernetes cluster with nodes. The OS is Ubuntu 22.04 LTS.

## âœ¨Steps

### ðŸ‘‰Step 1: Set up basic configuration

- Install the necessary software packages
```bash
sudo apt-get update -y && sudo apt-get upgrade -y
```

- Set time zone to `Europe/Brussels` on both servers.
```bash
sudo timedatectl set-timezone Europe/Brussels
```

- Set the hostname of the servers.
```bash
sudo hostnamectl set-hostname node00 # e.g. node01, node02, node03, ...
```

- Configure the network interfaces of the servers.
```bash
sudo rm /etc/netplan/50-cloud-init.yaml
sudo nano /etc/netplan/01-netcfg.yaml
```
```yaml
network:
  version: 2
  ethernets:
    ens18:
      dhcp4: no
      dhcp6: no
      accept-ra: no
      addresses:
        - 192.168.1.170/24 # e.g. 192.168.1.171, 192.168.1.172, 192.168.1.173, ...
      nameservers:
        addresses:
          - 192.168.1.120
          - 8.8.8.8
      routes:
        - to: default
          via: 192.168.1.1
```

- Apply the network configuration.
```bash
sudo chmod 600 /etc/netplan/01-netcfg.yaml
sudo chown root:root /etc/netplan/01-netcfg.yaml
sudo netplan apply
```

- Disable IPv6 on the servers & enable IP forwarding.
```bash
echo -e "net.ipv6.conf.all.disable_ipv6 = 1\nnet.ipv6.conf.default.disable_ipv6 = 1\nnet.ipv6.conf.lo.disable_ipv6 = 1net.ipv4.ip_forward = 1" | sudo tee /etc/sysctl.conf | sudo sysctl -p
```

- Add the hostnames to the `/etc/hosts` file.
```bash
echo -e "127.0.0.1 localhost\n192.168.1.171 node01\n192.168.1.172 node02\n192.168.1.173 node03\n192.168.1.174 node04\n192.168.1.175 node05\n192.168.1.176 node06\n192.168.1.177 node07\n192.168.1.178 node08\n192.168.1.179 node09" | sudo tee /etc/hosts > /dev/null
```

- Add the following lines to `/etc/motd` to display a welcome message when logging in.
```bash
sudo nano /etc/motd
```
```text
??????????????????????????????????????????JJJJJJJJJJJJJJJJ??????????????????????????????????????????
??????????????????????????????????JJJJJ???77!!!~~~~~~!!77???JJJJ????????????????????????????????????
??????????????????????????????JJJ??7~^::..               ..:^^~7??JJJ???????????????????????????????
???????????????????????????JJJ7!^:                              .:^!7JJJ????????????????????????????
????????????????????????JJ?7~:                                       :~7?J??????????????????????????
??????????????????????JJ?~:                                             .~?JJ???????????????????????
????????????????????J?!:.                                                 .~?JJ?????????????????????
??????????????????JJ7:                                                       ^7J????????????????????
?????????????????J?^                     ..:^~~~~~~~~^::.                      ~?J??????????????????
????????????????J!.                  .:~7???JJJJJJJJJJJ??7!~:.                  .7J?????????????????
??????????????J?^                 :^!?JJJ????????????????JJJJ?!^.                 ~J????????????????
?????????????J?:                ^7?JJ?????????????????????????JJ?~.                ~J???????????????
????????????J?:               :7JJ????????JJJ????????JJJJ????????J?!.               ~J??????????????
????????????J^              .~?J????????J?7~:.......:^~!7??????????J?^               ~J?????????????
???????????J!               7J????????J?~.              .^7??????????J~               7J????????????
??????????J?.              !J????????J7.             .^!???????????JJJ?.              :?????????????
??????????J~              ^J????????J!            :~7?JJ???????JJJ?7~:                 ?J???????????
???????????.              7J???????J7         .^~7?JJ???????JJ??!^.                .:~7?????????????
?????????J7              .????????J?.      .^!?JJJ??????JJJ?!~:                 :~!?JJJ?????????????
???????????.             .????????J^    :~7?JJ???????JJ?7~:.                .^!7?JJ?????????????????
???????????.             .?????????..:!??JJ??????JJJ?!^.                .^!7?JJJ????????????????????
??????????J^              7J?????????JJJ?????JJJ?7~:.               .:~7?JJJ???????JJ???????????????
??????????J!              7J??????????????JJ?7!^.               .:~7?JJJ???????JJJ?7~::?????????????
????????????.           :!J???????????????7^:                :~!?JJJ????????JJ??!^.   :?????????????
???????????J^       .^!??J?????????????J!.               :~!??JJ????????JJJ?7~:       7J????????????
???????????J7   .:~7?JJJ??????JJJ????????7~:.        .^!??JJJ???????JJJ?7~:.         :J?????????????
?????????????!!!?JJJ???????JJJ?77?JJJ????JJJ?77777777?JJJ???????JJJ?7~:.             7J?????????????
?????????????JJJ????????JJ?7~:.  .:!?JJJ?????JJJJJJJJ??????JJJ??7~:.                ~J??????????????
?????????????????????JJ?7~:          :~7?JJJJ????????JJJJJ?7!^:.                   ^J???????????????
???????????????????J?7~.                .:~7?????????77~^:.                       ~?????????????????
??????????????????J!.                        .::::::.                           :7J?????????????????
????????????????????~.                                                        ^!?J??????????????????
????????????????????J?~.                                                   :~7JJ????????????????????
??????????????????????J?7^                                              .~7?JJ??????????????????????
????????????????????????JJ?~:                                        :~7?JJ?????????????????????????
??????????????????????????JJ?7~^.                                .^!7?JJ????????????????????????????
?????????????????????????????JJJ??7!~^::..                 ..:^!7?JJJ???????????????????????????????
?????????????????????????????????JJJJJJ???77!~~~~~~~!!!!!77??JJJJ???????????????????????????????????
??????????????????????????????????????????JJJJJJJJJJJJJJJJJ?????????????????????????????????????????
????????????????????????????????????????????????????????????????????????????????????????????????????
------------------------------
- Welcome to server [node01] -
------------------------------
```

- Clean up the servers.
```bash
sudo apt-get autoremove -y && sudo apt-get autoclean -y
history -c
```

- Reboot the servers.
```bash
sudo reboot
```

### ðŸ‘‰Step 2: Install and Configure Kubernetes

- Disable swap on the node.
```bash
sudo swapoff -a
sudo nano /etc/fstab # Comment out the swap line
```

- Install a container runtime (Docker).
```bash
sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt install -y containerd.io
```

- Configure containerd.
```bash
sudo mkdir -p /etc/containerd
sudo su
containerd config default > /etc/containerd/config.toml
systemctl restart containerd
exit
```

- Install Kubernetes.
```bash
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
```

- Install Kubernetes tools.
```bash
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
sudo systemctl start kubelet
sudo kubeadm init phase kubelet-start
sudo systemctl status kubelet # (Optional)
```

### ðŸ‘‰Step 3: Initialize the Kubernetes cluster

- Initialize the Kubernetes cluster on the master node: **node01**
```bash
sudo kubeadm init --pod-network-cidr=10.0.0.0/8 --apiserver-advertise-address=192.168.1.171
# Copy the kubeadm join command e.g. kubeadm join 192.168.1.171:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>
```

- Configure the Kubernetes cluster: **node01**
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

- Install a pod network add-on (Calico): **node01**
```bash
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/tigera-operator.yaml
curl https://raw.githubusercontent.com/projectcalico/calico/v3.29.1/manifests/custom-resources.yaml -O
kubectl create -f custom-resources.yaml
watch kubectl get pods -n calico-system


kubectl get pods -n kube-system  # Check if all pods are running
sudo systemctl restart kubelet
sudo systemctl status kubelet
```




kubeadm join 192.168.1.171:6443 --token 26v2l6.0jhei689wqt6ml07 \
        --discovery-token-ca-cert-hash sha256:2369a41d701396592f281ffb1b00f924a149eb2615f647e7dcdfb1e06f52d669
kubectl get nodes



## ðŸ”—Links
- ðŸ‘¯ Web hosting company [EliasDH.com](https://eliasdh.com).
- ðŸ“« How to reach us elias.dehondt@outlook.com